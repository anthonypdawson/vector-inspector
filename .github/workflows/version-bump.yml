name: Version Bump

on:
  push:
    branches: [ master ]
    paths:
      - 'pyproject.toml'
  workflow_dispatch:

concurrency:
  group: version-bump-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  id-token: write
jobs:
  on_version_bump:
    name: Detect version change
    runs-on: ubuntu-latest
    if: ${{ github.event.repository.fork != true && github.ref == 'refs/heads/master' }}
    outputs:
      changed: ${{ steps.detect.outputs.changed }}
      current: ${{ steps.detect.outputs.current }}
      previous: ${{ steps.detect.outputs.previous }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # we need history to compare versions

      - name: Detect version change
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          # Current version from pyproject (supports generic 'version = "x.y.z"' anywhere)
          curr=$(grep -Po '^\s*version\s*=\s*"\K[^"]+' pyproject.toml || true)

          # Previous version from prior commit of the file (if it existed)
          prev=$(git show HEAD^:pyproject.toml 2>/dev/null | grep -Po '^\s*version\s*=\s*"\K[^"]+' || true)

          changed=false
          if [[ -n "$curr" && "$curr" != "$prev" ]]; then changed=true; fi

          echo "current=$curr" >> "$GITHUB_OUTPUT"
          echo "previous=$prev" >> "$GITHUB_OUTPUT"
          echo "changed=$changed" >> "$GITHUB_OUTPUT"

      - name: Show detected versions
        run: |
          echo "Previous: ${{ steps.detect.outputs.previous }}"
          echo "Current:  ${{ steps.detect.outputs.current }}"

  publish_on_bump:
    name: Publish on version bump
    needs: on_version_bump
    if: ${{ needs.on_version_bump.outputs.changed == 'true' && github.event.repository.fork != true && github.ref == 'refs/heads/master' }}
    uses: ./.github/workflows/publish.yml
    with:
      version: ${{ needs.on_version_bump.outputs.current }}